<!DOCTYPE html>
<html lang="vi" ng-app="StudentManagementApp">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Quản Lý Sinh Viên</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/index.css" />
    <link rel="stylesheet" href="~/css/toast.css" />


</head>
<body ng-controller="MainController">
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h5><i class="fas fa-graduation-cap"></i> QLSV</h5>
            </div>
            <nav>
                <a href="/statistic" class="nav-link">
                    <i class="fas fa-home"></i> Trang chủ
                </a>

                <!-- Menu cho Admin -->
                <div ng-if="currentUser.role === 'Admin'">
                    <a href="/department" class="nav-link">
                        <i class="fas fa-building"></i> Quản lý Khoa
                    </a>
                    <a href="/teacher" class="nav-link">
                        <i class="fas fa-chalkboard-teacher"></i> Quản lý Giáo viên
                    </a>
                    <a href="/student" class="nav-link">
                        <i class="fas fa-user-graduate"></i> Quản lý Sinh viên
                    </a>
                    <a href="/class" class="nav-link">
                        <i class="fas fa-users"></i> Quản lý Lớp học
                    </a>
                    <a href="/subject" class="nav-link">
                        <i class="fas fa-book"></i> Quản lý Môn học
                    </a>
                    <a href="/grade" class="nav-link">
                        <i class="fas fa-chart-line"></i> Quản lý Điểm
                    </a>
                    <a href="/user" class="nav-link">
                        <i class="fas fa-user"></i> Quản lý Tài Khoản
                    </a>
                </div>

                <!-- Menu cho Teacher -->
                <div ng-if="currentUser.role === 'Teacher'">
                    <a href="/class" class="nav-link">
                        <i class="fas fa-users"></i> Lớp của tôi
                    </a>
                    <a href="/subject" class="nav-link">
                        <i class="fas fa-book"></i> Môn giảng dạy
                    </a>
                    <a href="/grade" class="nav-link">
                        <i class="fas fa-edit"></i> Nhập điểm
                    </a>
                </div>

                <!-- Menu cho Student -->
                <div ng-if="currentUser.role === 'Student'">
                    <a href="/grade" class="nav-link">
                        <i class="fas fa-chart-bar"></i> Xem điểm
                    </a>
                </div>
                <div ng-if="currentUser.role === 'Student'">
                    <a href="/subject" class="nav-link">
                        <i class="fas fa-book"></i> Chương trình đào tạo
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="topbar-left">
                    <a href="#!/home" class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Quản Lý Sinh Viên</span>
                    </a>
                </div>
                <div class="topbar-right">
                    <!-- Hiển thị khi đã đăng nhập -->
                    <div ng-if="isLoggedIn" class="dropdown">
                        <div class="user-info" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar">
                                {{getInitials(currentUser.fullName)}}
                            </div>
                            <div>
                                <div style="font-weight: 500;">{{currentUser.fullName}}</div>
                                <small class="text-muted">{{currentUser.role}}</small>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i> Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i> Cài đặt</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" ng-click="logout()"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a></li>
                        </ul>
                    </div>

                    <!-- Hiển thị khi chưa đăng nhập -->
                    <a ng-if="!isLoggedIn" href="/login" class="login-btn">
                        <i class="fas fa-sign-in-alt me-1"></i> Đăng nhập
                    </a>
                </div>
            </header>

            <!-- Content area -->
            <main class="content-area">
                @RenderBody()
            </main>

            <!-- Footer -->
            <footer class="footer">
                <div class="container">
                    <p class="mb-0">Hệ thống Quản lý Sinh viên.</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular-route.min.js"></script>
    <!-- App Scripts -->
    <script src="~/js/app.js"></script>
    <script src="~/js/Controllers/DepartmentController.js"></script>
    <script src="~/js/Services/apiService.js"></script>
    <script src="~/js/Services/ToastService.js"></script>
    <script src="~/js/Controllers/LoginController.js"></script>
    <script src="~/js/Controllers/TeacherController.js"></script>
    <script src="~/js/Controllers/StudentController.js"></script>
    <script src="~/js/Controllers/ClassController.js"></script>
    <script src="~/js/Controllers/SubjectController.js"></script>
    <script src="~/js/Controllers/GradeController.js"></script>
    <script src="~/js/Controllers/UserController.js"></script>
    <script src="~/js/Controllers/StatisticController.js"></script>


    <!-- Main Controller Script -->
    <script>
        angular.module('StudentManagementApp')
            .controller('MainController', ['$scope', '$window', '$location', function($scope, $window, $location) {
                // Kiểm tra trạng thái đăng nhập
                function checkLoginStatus() {
                    var currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    $scope.isLoggedIn = !!currentUser.userId;
                    $scope.currentUser = currentUser;
                }

                // Lấy chữ cái đầu từ tên
                $scope.getInitials = function(fullName) {
                    if (!fullName) return '?';
                    var names = fullName.split(' ');
                    if (names.length >= 2) {
                        return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
                    }
                    return fullName.charAt(0).toUpperCase();
                };

                // Đăng xuất
                $scope.logout = function() {
                    if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                        localStorage.removeItem('currentUser');
                        $scope.isLoggedIn = false;
                        $scope.currentUser = {};
                        $location.path('/login');
                    }
                };

                // Khởi tạo
                checkLoginStatus();

                // Lắng nghe sự thay đổi của localStorage
                $window.addEventListener('storage', function() {
                    $scope.$apply(function() {
                        checkLoginStatus();
                    });
                });

                // Lắng nghe sự kiện login thành công
                $scope.$on('loginSuccess', function() {
                    checkLoginStatus();
                });
            }]);
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>